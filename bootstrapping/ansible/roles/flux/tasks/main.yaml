- name: Install Flux CLI
  ansible.builtin.shell: |
    wget -c https://github.com/fluxcd/flux2/releases/download/v{{ flux_cli_version }}/flux_{{ flux_cli_version }}_linux_amd64.tar.gz -O - \
      | tar -xz -C /usr/local/bin/
  args:
    executable: /bin/bash

- name: Bootstrap Flux to the cluster
  ansible.builtin.shell: |
    flux install \
      --components="source-controller,kustomize-controller,helm-controller,notification-controller" \
      --registry=docker.io/fluxcd \
      --kubeconfig=/etc/rancher/rke2/rke2.yaml
  when: 
  - inventory_hostname == groups[rke2_servers_group_name].0

- when: 
  - install_oci_artifact == true
  - inventory_hostname == groups[rke2_servers_group_name].0
  block: 
  - name: Get cluster OCI artifact
    ansible.builtin.shell: |
      flux pull artifact oci://ghcr.io/arsenikki/kuberseni-gitops:latest --output /tmp
  
  - name: Apply resources
    ansible.builtin.shell: |
      /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml apply -f {{ item }}
    args:
      executable: /bin/bash
    loop:
      - /tmp/base/flux-system/repositories/oci/kuberseni-gitops-source.yaml
      - /tmp/base/flux-system/gotk-sync.yaml
