- name: Create Longhorn default disk directory if it does not exist
  ansible.builtin.file:
    path: /longhorn
    state: directory
    mode: '0755'

- name: Label and annotate nodes with Longhorn default data disk configs 
  kubernetes.core.k8s:
    state: patched
    kind: Node
    name: "{{ inventory_hostname }}"
    kubeconfig: /etc/rancher/rke2/rke2.yaml
    definition:
      metadata:
        labels:
          node.longhorn.io/create-default-disk: 'config'
        annotations:  
          node.longhorn.io/default-disks-config: '[{ "name":"sas-disk", "path":"/longhorn", "allowScheduling":true, "storageReserved":34359738368, "tags":["fast"]}]'

- name: Install Longhorn dependencies
  ansible.builtin.apt:
    name:
      - open-iscsi
      - nfs-common
      - jq
    state: present
    update_cache: true

- name: Collect Longhorn dependency statuses
  ansible.builtin.shell: |
    set -e
    curl -sSfL https://raw.githubusercontent.com/longhorn/longhorn/{{ longhorn_version }}/scripts/environment_check.sh | bash | sed 's/\x1b\[[0-9;]*m//g'
  args:
    executable: /bin/bash
  changed_when: false
  retries: 5
  register: longhorn_dependency_status

- name: Summary of Longhorn dependency statuses
  ansible.builtin.debug:
    var: longhorn_dependency_status.stdout_lines