# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
version: 1
metadata:
  name: update-embedded-outpost
entries:
  # Ensure dependencies are applied first
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: n8n
      required: true
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: prowlarr
      required: true
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: qbittorrent
      required: true
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: radarr
      required: true
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: sonarr
      required: true
  - model: authentik_blueprints.metaapplyblueprint
    attrs:
      identifiers:
        name: whoami
      required: true
  # Patch default embedded outpost to include apps
  - model: authentik_outposts.outpost
    state: present
    identifiers:
      name: "authentik Embedded Outpost"
    attrs:
      providers:
        - !Find [authentik_providers_proxy.proxyprovider, [name, "n8n"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "prowlarr"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "qbittorrent"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "radarr"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "sonarr"]]
        - !Find [authentik_providers_proxy.proxyprovider, [name, "whoami"]]
      config:
        authentik_host: https://authentik.${SECRET_DOMAIN}
        kubernetes_disabled_components:
          - "traefik middleware"
        kubernetes_ingress_annotations:
          # Automatically generate TLS certificate
          kubernetes.io/tls-acme: "true"
